<template>
  <div class="table">
    <div class="crumbs">
      <el-breadcrumb separator="/">
        <el-breadcrumb-item>
          <i class="el-icon-tickets"></i> 运单列表
        </el-breadcrumb-item>
      </el-breadcrumb>
    </div>
    <div class="container">
      <div class="handle-box">
        <el-button type="primary" @click="temperatureInformation()">导出</el-button>

        <el-form :inline="true" style="margin: 20px 0 0 0;">
          <el-row>
            <el-col>
              <el-form-item label="订单号">
                <el-input v-model="Order_number" type="number" placeholder="只能输入数字"></el-input>
              </el-form-item>
              <el-form-item label="运单号">
                <el-input v-model="Waybill_number"></el-input>
              </el-form-item>
              <el-form-item label="运单状态">
                <el-select v-model="select_cate" placeholder="请选择" class="handle-select mr10">
                  <el-option key="0" label="代取件" value="0"></el-option>
                  <el-option key="1" label="已取件" value="1"></el-option>
                  <el-option key="2" label="已入库" value="2"></el-option>
                  <el-option key="3" label="已出港" value="3"></el-option>
                  <el-option key="4" label="已入港" value="4"></el-option>
                  <el-option key="5" label="签收完成!" value="签收完成!"></el-option>
                  <el-option key="6" label="配载完成" value="配载完成"></el-option>
                </el-select>
              </el-form-item>

              <el-form-item label="发货时间">
                <el-date-picker
                  v-model="value4"
                  value-format="yyyy-MM-dd HH:mm:ss"
                  type="datetimerange"
                  :picker-options="pickerOptions2"
                  range-separator="至"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
                ></el-date-picker>
              </el-form-item>
              <el-button type="primary" icon="search" @click="getData">搜索</el-button>
            </el-col>
          </el-row>
        </el-form>
      </div>
      <el-table
        :data="tableData"
        border
        style="width: 100%"
        ref="multipleTable"
        @selection-change="handleSelectionChange"
        v-loading="loading"
      >
        <el-table-column type="selection" width="60" align="center"></el-table-column>
        <el-table-column type="index" width="50" label="序号" align="center"></el-table-column>
        <el-table-column prop="ID" label="TMS订单号" align="center"></el-table-column>
        <el-table-column prop="Condition" label="运单状态" align="center" :formatter="formatter"></el-table-column>
        <el-table-column prop="BillNUmber" label="运单号" align="center" :show-overflow-tooltip="true"></el-table-column>
        <el-table-column prop="TakeTime" label="运单生成时间" align="center" :show-overflow-tooltip="true"></el-table-column>
        <el-table-column
          prop="SendsAddress"
          label="发货地址"
          align="center"
          :show-overflow-tooltip="true"
        ></el-table-column>
        <el-table-column prop="GetsTime" label="收货时间" align="center" :formatter="timesta" :show-overflow-tooltip="true"></el-table-column>
        <el-table-column
          prop="GetAddress"
          label="收货地址"
          align="center"
          :show-overflow-tooltip="true"
        ></el-table-column>
        <el-table-column label="操作" align="center" width="250">
          <template slot-scope="scope">
            <el-button size="small" type="primary" @click.native.prevent="details(scope.row)">详情</el-button>
            <el-button
              size="small"
              type="warning"
              @click.native.prevent="TemperatureList(scope.row)"
            >温度</el-button>
          </template>
        </el-table-column>
      </el-table>
      <div class="pagination">
        <el-pagination
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
        
          :page-sizes="[50, 100, 500, 2000]"
          :page-size="50"
          layout="total, sizes, prev, pager, next, jumper"
          :total="ccc"
        ></el-pagination>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      Waybill_number: "", //运单号
      Order_number: "", //订单号
      select_cate: "", //运单状态
      tableData: [],
      GetsTime: "",
      loading: true,
      form: {
        Waybill_number: "",
        Order_number: ""
      },
      cur_page: 1,
      limit:50,
      ccc: 0, //总页数
      token: "",
      value4: [], //发货时间
      multipleSelection: [],
      pickerOptions2: {
        shortcuts: [
          {
            text: "最近一周",
            onClick(picker) {
              const end = new Date();
              const start = new Date();
              start.setTime(start.getTime() - 3600 * 1000 * 24 * 7);
              picker.$emit("pick", [start, end]);
            }
          },
          {
            text: "最近一个月",
            onClick(picker) {
              const end = new Date();
              const start = new Date();
              start.setTime(start.getTime() - 3600 * 1000 * 24 * 30);
              picker.$emit("pick", [start, end]);
            }
          },
          {
            text: "最近三个月",
            onClick(picker) {
              const end = new Date();
              const start = new Date();
              start.setTime(start.getTime() - 3600 * 1000 * 24 * 90);
              picker.$emit("pick", [start, end]);
            }
          }
        ]
      }
    };
  },
  created() {
    this.token = window.sessionStorage.getItem("token");
    this.getData();
  },
  methods: {
    // 分页导航
    handleSelectionChange(val) {
      // 选中的  当前条 数据
      this.multipleSelection = val;
    },
    // 分页导航
    handleCurrentChange(val) {
      this.loading = true;
      this.cur_page = val;
      this.getData();
    },
    handleSizeChange(val){
        // console.log(val); // 每页显示  条数
        this.loading = true;
        this.limit  = val;
        this.getData();
    },
    getData() {
      if (this.value4 == null) {
        this.value4 = ["", ""];
      }
      this.$axios
        .post(
          this.URL_API + "/berry/public/index.php/Init_way_bill/index",
          {
            page: this.cur_page, //当前页
            limit: this.limit,
            BillNumber: this.Waybill_number, //运单号
            Condition: this.select_cate, // 0 未完成 1 已完成
            ID: this.Order_number, //订单号
            TakeTime: this.value4[0] || "", // 下单开始时间
            GetsTime: this.value4[1] || "" // 下单结束时间
          },
          {
            transformRequest: [
              function(data) {
                let ret = "";
                for (let it in data) {
                  ret +=
                    encodeURIComponent(it) +
                    "=" +
                    encodeURIComponent(data[it]) +
                    "&";
                }
                return ret;
              }
            ]
          }
        )
        .then(res => {
          if (res.data.code == 0) {
            this.tableData = res.data.data;
            this.ccc = res.data.sum;
            this.loading = false;
          }else if(res.data.code == 450){
            this.$message.success("登录时间过长，请重新登录");
            this.$router.push("/login");
          } else {
            this.tableData = [];
            this.ccc = 1;
            this.loading = false;
            this.$message.error(res.data.message);
          }
        });
    },
    //过滤运单状态
    formatter(row, column) {
      switch (row.Condition) {
        case "配载完成":
          return "配载完成";
          break;
        case "签收完成!":
          return "签收完成!";
          break;
        case null:
          return "暂无";
          break;
        case "已取货":
          return "已取货";
          break;
        case "已签收":
          return "已签收";
          break;
        case "已返箱":
          return "已返箱";
          break;
        case "已拒单":
          return "已拒单";
          break;
        case "已完成":
          return "已完成";
          break;
      }
    },

    //
    timesta(row, column) {
      // return  this.GetsTime = row.GetsTime||"暂无";
      // return this.GetsTime == null ? new date() : row.GetsTime;
      if (row.GetsTime == null) {
        // let time = new date();
        return "暂无";
      } else {
        return row.GetsTime;
      }
    },
    temperatureInformation() {
      let len = this.multipleSelection;
      if (len.length == 1) {
        this.id = len[0].id;
        // 获取温度信息数据
      } else if (len.length == 0) {
        this.$message.error("请选择导出信息");
      } else {
        this.$message.error("请选择单个数据");
      }
    },

    //详情
    details(rows) {
      let detailsID = rows.ID;
      // var detailId = id.toString() ;

      window.localStorage.setItem("detailsID", detailsID);
      this.$router.push({ path: "/WaybillDetails" });
      /*         this.$axios.post(
                    this.URL_API + "/berry/public/index.php/init_way_bill/way_default",
                    {
                        o_id: detailsID
                    },
                    {
                        transformRequest: [
                            function(data) {
                                let ret = "";
                                for (let it in data) {
                                    ret +=
                                        encodeURIComponent(it) +
                                        "=" +
                                        encodeURIComponent(data[it]) +
                                        "&";
                                }
                                return ret;
                            }
                        ],
                     headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" }
                    }
                ).then(res => {

                    if(res.data.code == '1'){
                        console.log(res.data,99)

                        this.$router.push({path:"/WaybillDetails"});

                       window.localStorage.setItem('data2',JSON.stringify(res.data));
                        window.localStorage.setItem('detailsID',detailsID);
                    }else if(res.data.code == '450'){
                        this.$message("暂无权限");
                    }
                });*/
    },
    /*   details(rows){
                let id = rows.ID;
                var detailId = id.toString() ;
               // console.log(typeof (detailId),9);

                // 详情

                this.$axios({
                    url: "http://localhost:8080/api//berry/public/index.php/init_way_bill/way_default",
                    method: "post",
                    data: { o_id: detailId,token: window.sessionStorage.getItem("token") },
                    transformRequest: [
                        function(data) {
                            let ret = "";
                            for (let it in data) {
                                ret +=
                                    encodeURIComponent(it) +
                                    "=" +
                                    encodeURIComponent(data[it]) +
                                    "&";
                            }
                            return ret;
                        }
                    ],
                    headers: { "Content-Type": "application/x-www-form-urlencoded" }
                }).then(function(res) {
                    console.log(res,888);
                    return
                    if(res.data.code == '0'){

                        that.$router.push({path:"/billDetails"});
                        window.localStorage.setItem('data',JSON.stringify(res.data));
                        // that.options = res.data.data;
                    }else if(res.data.code == '450'){
                        that.$message("暂无权限");
                    }

                });
            },*/

    //温度详情页
    TemperatureList(rows) {
      let BillNumber = rows.BillNUmber;

      this.$axios
        .post(
          this.URL_API + "/berry/public/index.php/Init_way_bill/temperature",
          {
            BillNumber: BillNumber
          },
          {
            transformRequest: [
              function(data) {
                let ret = "";
                for (let it in data) {
                  ret +=
                    encodeURIComponent(it) +
                    "=" +
                    encodeURIComponent(data[it]) +
                    "&";
                }
                return ret;
              }
            ]
          }
        )
        .then(res => {
          if (res.data.code == "0") {
            this.$router.push({ path: "/TemperatureList" });
            window.localStorage.setItem("data1", JSON.stringify(res.data));
            window.localStorage.setItem("BillNumber", BillNumber);
          } else if (res.data.code == "450") {
            this.$message("暂无权限");
          }
        });
    }
  }
};
</script>
<style>
.el-table {
  color: #000;
}
</style>

<style scoped>

.handle-box {
  margin-bottom: 20px;
}

.handle-select {
  width: 120px;
}

td,
th {
  border: solid #ccc;
  border-width: 0px 1px 1px 0px;
  padding: 10px 0px;
  text-align: center;
}

table {
  border: solid #ccc;
  border-width: 1px 0px 0px 1px;
  border-collapse: collapse;
  width: 100%;
}
.table_td {
  background-color: #eff4f6;
}
</style>
